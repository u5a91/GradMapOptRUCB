<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gradient Mapping Optimization RUCB</title>
  <link rel="stylesheet" href="static/style.css">
</head>
<body>
  <h1>Color Gradient RUCB Demo</h1>

  <!-- Setup -->
  <div id="config">
    <label>Iterations: <input type="number" id="inputIter" value="20" min="1"></label>
    <label>Colors: <input type="number" id="inputK" value="5" min="2"></label>
  </div>

  <!-- Upload -->
  <div id="uploadSection">
    <input type="file" id="fileInput" accept="image/*">
    <button id="uploadBtn">Upload Image</button>
  </div>

  <!-- Pair -->
  <div id="images">
    <div class="image-block">
      <img
        id="imgA"
        class="main"
        src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
        alt="Option A"
      />
      <img
        id="barA"
        class="bar"
        src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
        alt="Gradient A"
      />
      <pre id="paletteA"></pre>
    </div>
    <div class="image-block">
      <img id="imgB" 
        class="main"
        src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
        alt="Option B"
      />
      <img id="barB" 
        class="bar"
        src="data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs="
        alt="Gradient B"
        />
      <pre id="paletteB"></pre>
    </div>
  </div>

  <!-- Choice -->
  <div id="controls">
    <button id="chooseA" disabled>Choose A</button>
    <button id="chooseB" disabled>Choose B</button>
  </div>
  <div id="status"></div>

<script>
  const fileInput   = document.getElementById('fileInput');
  const uploadBtn   = document.getElementById('uploadBtn');
  const imgA        = document.getElementById('imgA');
  const imgB        = document.getElementById('imgB');
  const barA        = document.getElementById('barA');
  const barB        = document.getElementById('barB');
  const paletteA    = document.getElementById('paletteA');
  const paletteB    = document.getElementById('paletteB');
  const btnA        = document.getElementById('chooseA');
  const btnB        = document.getElementById('chooseB');
  const status      = document.getElementById('status');
  const inputIter   = document.getElementById('inputIter');
  const inputK      = document.getElementById('inputK');

  let totalIterations = 20;

  function formatRGB(arr) {
    return `(${Math.round(arr[0]*255)}, ${Math.round(arr[1]*255)}, ${Math.round(arr[2]*255)})`;
  }

  async function fetchNext() {
    console.log('fetchNext() called, iteration limit =', totalIterations);
    try {
      const res = await fetch(`palette/next/`);
      console.log('fetchNext response status:', res.status);
      if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
      const data = await res.json();
      // Main images
      imgA.src = data.A;
      imgB.src = data.B;
      // Gradient bars
      barA.src = data.barA;
      barB.src = data.barB;
      // Palette lists
      const palA = data.palA;
      const palB = data.palB;
      paletteA.textContent = palA.map((c,i) => `color ${i+1}: ${formatRGB(c)}`).join('\n');
      paletteB.textContent = palB.map((c,i) => `color ${i+1}: ${formatRGB(c)}`).join('\n');
      // Iteration info
      status.textContent = `Iteration ${data.iteration} / ${data.total_iterations}`;
      btnA.disabled = btnB.disabled = false;
    } catch (err) {
      console.error('Error in fetchNext:', err);
      status.textContent = 'Error fetching next pair: ' + err.message;
    }
  }

  async function sendChoice(choice) {
    console.log('sendChoice() called with choice =', choice);
    btnA.disabled = btnB.disabled = true;
    try {
      const res = await fetch(`palette/choice/`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: `choice=${choice}`
      });
      console.log('sendChoice response status:', res.status);
      if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
      const data = await res.json();
      console.log('sendChoice response JSON:', data);
      if (data.next_iteration > totalIterations) {
        status.textContent = 'Completed all iterations!';
      } else {
        fetchNext();
      }
    } catch (err) {
      console.error('Error in sendChoice:', err);
      status.textContent = 'Error sending choice: ' + err.message;
    }
  }

  async function uploadImage() {
    console.log('uploadImage() called');
    const file = fileInput.files[0];
    if (!file) {
      console.warn('No file selected');
      return alert('画像を選んでください / No file selected');
    }
    totalIterations = parseInt(inputIter.value, 10) || 20;
    const k = parseInt(inputK.value, 10) || 5;

    const form = new FormData();
    form.append('file', file);
    form.append('n_iter_form', totalIterations);
    form.append('k_form', k);
    console.log('FormData entries:', [...form.entries()]);

    try {
      const res = await fetch(`upload/`, {
        method: 'POST',
        body: form
      });
      console.log('upload response status:', res.status);
      if (!res.ok) throw new Error(`${res.status} ${await res.text()}`);
      const data = await res.json();
      console.log('upload JSON:', data);
      status.textContent = 'Upload & reset successful! Fetching first pair…';
      fetchNext();
    } catch (err) {
      console.error('Error in uploadImage:', err);
      status.textContent = 'Upload failed: ' + err.message;
    }
  }

  uploadBtn.addEventListener('click', uploadImage);
  btnA.addEventListener('click', () => sendChoice('A'));
  btnB.addEventListener('click', () => sendChoice('B'));
</script>
</body>
</html>